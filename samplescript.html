<!DOCTYPE html>
<html>
  <head>    
  <meta charset="utf-8">
  <title> Sample Page </title>
  <script src="d3.min.js"></script>
  <script type="text/javascript" src="simple-excel.js"></script>
  <script src="http://www.d3plus.org/js/d3.js"></script>
  <script src="http://www.d3plus.org/js/d3plus.js"></script>
</head>
<body>
<input type="file" id="fileInput" /><br/>
        <input type="button" id="fileExport" />
<h2> Profits Per Inbound Account </h2>
<div id="viz"></div>
  <script>	
  var csvParser = new SimpleExcel.Parser.CSV();
            var fileInput = document.getElementById('fileInput');
       
            fileInput.addEventListener('change', function (e) 
            {            
                var file = e.target.files[0];
                csvParser.loadFile(file, function () 
                {
                	var smartdata = csvParser.getSheet();
         			list = [];
         			var inbound = [];
         			var inboundsum = [];
         			var outboundsum = [];
         			var profits = [];
         			var data = [];
         			var sum = 0;
                	for(i=0; i < smartdata.length; i++)
                	{
                		var temp = smartdata[i];
                		list.push(temp[4]);
                		inbound.push([temp[4], temp[10]]);         		
                
    	            };
    	            var uniq = list
 					 .map((name) => {
   					 return {count: 1, name: name}
 					 })
 					 .reduce((a, b) => {
   					 a[b.name] = (a[b.name] || 0) + b.count
  					  return a
  					}, {})

 					 var sorted = Object.keys(uniq).sort((a, b) => uniq[a] < uniq[b])
 					 for (var i = 0, inboundsum; i < sorted.length; i++) inboundsum.push(0);
 					 for (var i = 0, outboundsum; i < sorted.length; i++) outboundsum.push(0);
 					 for (var i = 0, profits; i < sorted.length; i++) profits.push(0);

 					 console.log(inboundsum.length)

				   for(j=0; j < sorted.length; j++)
                        {
                            var tempuniqe = sorted[j];
                            
                            for(i=0; i < smartdata.length; i++)
                                {
                                	var temp = smartdata[i];
                                	if (tempuniqe == temp[4])
                                	{
                                		
                                    	inboundsum[j] += Number(temp[10]);
                                    	outboundsum[j] += Number(temp[19]);
                                	}
                                }
                        if (isNaN(inboundsum[j])) inboundsum[j] = 0;       
                        if (isNaN(outboundsum[j])) outboundsum[j] = 0; 
                        sum += outboundsum[j];

						profits[j] = outboundsum[j] - inboundsum[j];   
						data.push({label:sorted[j], value:profits[j]});
						}
					console.log(uniq);
					console.log(inboundsum);
					console.log(outboundsum);
					console.log(profits);
					console.log(data);
					console.log(sum);

 				d3plus.viz()
   				 .container("#viz")
   				 .data(data)
  				  .type("pie")
   				 .id("label")
   				 .size("value")
  				  .draw()

            	});
            });
            

  </script>
</body>
</html>
